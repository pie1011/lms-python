{% extends "student/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1 class="dashboard-title">Welcome back, {{ profile.first_name }}!</h1>
    <p class="dashboard-subtitle">Here's your academic progress overview</p>
</div>

<!-- Statistics Cards -->
<div class="dashboard-grid">
    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon blue">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="card-value">{{ total_courses }}</div>
        </div>
        <h3 class="card-title">Enrolled Courses</h3>
        <p class="card-description">Active course enrollments this term</p>
    </div>

    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon green">
                <i class="fas fa-tasks"></i>
            </div>
            <div class="card-value">{{ total_submissions }}</div>
        </div>
        <h3 class="card-title">Total Submissions</h3>
        <p class="card-description">{{ graded_submissions }} graded, {{ total_submissions|add:"-"|add:graded_submissions }} pending</p>
    </div>

    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon orange">
                <i class="fas fa-star"></i>
            </div>
            <div class="card-value">
                {% if graded_submissions > 0 %}
                    {% widthratio total_grade_points graded_submissions 1 %}%
                {% else %}
                    --
                {% endif %}
            </div>
        </div>
        <h3 class="card-title">Average Grade</h3>
        <p class="card-description">Based on graded assignments</p>
    </div>

    <div class="dashboard-card">
        <div class="card-header">
            <div class="card-icon purple">
                <i class="fas fa-clock"></i>
            </div>
            <div class="card-value">{{ recent_assignments|length }}</div>
        </div>
        <h3 class="card-title">Recent Assignments</h3>
        <p class="card-description">New assignments this week</p>
    </div>
</div>

<!-- Enrolled Courses Section -->
{% if enrollments %}
<div class="dashboard-card" style="margin-bottom: 2rem;">
    <h2 class="card-title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">
        <i class="fas fa-graduation-cap"></i>
        Your Courses
    </h2>
    
    <div class="course-grid">
        {% for enrollment in enrollments %}
        <div class="course-card">
            <div class="course-header">
                <div class="course-code">{{ enrollment.course.course_code }}</div>
                <h3 class="course-title">{{ enrollment.course.course_name }}</h3>
                <p class="course-instructor">
                    <i class="fas fa-user"></i>
                    {{ enrollment.course.instructor.userprofile.first_name|default:enrollment.course.instructor.first_name }} 
                    {{ enrollment.course.instructor.userprofile.last_name|default:enrollment.course.instructor.last_name }}
                </p>
            </div>

            <div class="course-stats">
                <span><strong>Term:</strong> {{ enrollment.course.term }}</span>
                <span><strong>Credits:</strong> {{ enrollment.course.credits }}</span>
            </div>

            {% if enrollment.current_grade %}
            <div class="course-stats">
                <span><strong>Current Grade:</strong> {{ enrollment.current_grade }}%</span>
                <span><strong>Status:</strong> 
                    <span style="color: {% if enrollment.status == 'active' %}var(--accent-green){% else %}var(--neutral-gray){% endif %};">
                        {{ enrollment.get_status_display }}
                    </span>
                </span>
            </div>
            {% endif %}

            <div class="course-actions">
                <a href="#" class="btn btn-primary">
                    <i class="fas fa-eye"></i>
                    View Course
                </a>
                <a href="#" class="btn btn-outline">
                    <i class="fas fa-tasks"></i>
                    Assignments
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recent Assignments Section -->
{% if recent_assignments %}
<div class="dashboard-card" style="margin-bottom: 2rem;">
    <h2 class="card-title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">
        <i class="fas fa-clipboard-list"></i>
        Recent Assignments
    </h2>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--neutral-light);">
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--neutral-dark);">Assignment</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--neutral-dark);">Course</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--neutral-dark);">Due Date</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--neutral-dark);">Status</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--neutral-dark);">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for assignment in recent_assignments %}
                <tr style="border-bottom: 1px solid rgba(37, 99, 235, 0.1);">
                    <td style="padding: 1rem;">
                        <div style="font-weight: 600; color: var(--neutral-dark);">{{ assignment.assignment_name }}</div>
                        <div style="font-size: 0.8rem; color: var(--neutral-gray);">{{ assignment.assignment_type|capfirst }} • {{ assignment.max_points }} points</div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="font-weight: 500; color: var(--primary-blue);">{{ assignment.module.course.course_code }}</div>
                        <div style="font-size: 0.8rem; color: var(--neutral-gray);">{{ assignment.module.module_name }}</div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="color: var(--neutral-dark);">{{ assignment.due_date|date:"M j, Y" }}</div>
                        <div style="font-size: 0.8rem; color: var(--neutral-gray);">{{ assignment.due_date|time:"g:i A" }}</div>
                    </td>
                    <td style="padding: 1rem;">
                        {% with submission=assignment.submissions.first %}
                            {% if submission %}
                                <span style="color: {% if submission.status == 'graded' %}var(--accent-green){% elif submission.status == 'submitted' %}var(--accent-orange){% else %}var(--neutral-gray){% endif %};">
                                    {% if submission.status == 'graded' %}
                                        <i class="fas fa-check-circle"></i> Graded
                                    {% elif submission.status == 'submitted' %}
                                        <i class="fas fa-clock"></i> Submitted
                                    {% else %}
                                        <i class="fas fa-question-circle"></i> {{ submission.get_status_display }}
                                    {% endif %}
                                </span>
                            {% else %}
                                <span style="color: #ef4444;">
                                    <i class="fas fa-exclamation-circle"></i> Not Submitted
                                </span>
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td style="padding: 1rem;">
                        <a href="#" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                            <i class="fas fa-eye"></i>
                            View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Recent Submissions Section -->
{% if recent_submissions %}
<div class="dashboard-card">
    <h2 class="card-title" style="font-size: 1.5rem; margin-bottom: 1.5rem;">
        <i class="fas fa-file-upload"></i>
        Recent Submissions
    </h2>
    
    {% for submission in recent_submissions %}
    <div style="padding: 1rem; border: 1px solid rgba(37, 99, 235, 0.1); border-radius: 8px; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div>
                <h4 style="margin: 0; color: var(--neutral-dark);">{{ submission.assignment.assignment_name }}</h4>
                <p style="margin: 0; font-size: 0.9rem; color: var(--neutral-gray);">
                    {{ submission.assignment.module.course.course_code }} • 
                    Submitted {{ submission.submission_date|date:"M j, Y \a\t g:i A" }}
                </p>
            </div>
            <div style="text-align: right;">
                {% if submission.grade %}
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary-blue);">
                        {{ submission.grade }}/{{ submission.assignment.max_points }}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--neutral-gray);">
                        {{ submission.grade|floatformat:0 }}%
                    </div>
                {% else %}
                    <div style="color: var(--accent-orange); font-weight: 600;">
                        <i class="fas fa-clock"></i> Pending
                    </div>
                {% endif %}
            </div>
        </div>
        
        {% if submission.feedback %}
        <div style="background: rgba(37, 99, 235, 0.05); padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
            <strong style="color: var(--primary-blue);">Instructor Feedback:</strong>
            <p style="margin: 0.25rem 0 0 0; color: var(--neutral-dark);">{{ submission.feedback|truncatewords:20 }}</p>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Empty State for New Students -->
{% if not enrollments %}
<div class="dashboard-card" style="text-align: center; padding: 3rem;">
    <i class="fas fa-graduation-cap" style="font-size: 3rem; color: var(--neutral-gray); margin-bottom: 1rem;"></i>
    <h3 style="color: var(--neutral-dark); margin-bottom: 0.5rem;">Welcome to the Student Portal!</h3>
    <p style="color: var(--neutral-gray); margin-bottom: 2rem;">You're not enrolled in any courses yet. Contact your administrator to get enrolled in courses.</p>
    <a href="{% url 'index' %}" class="btn btn-primary">
        <i class="fas fa-home"></i>
        Back to Main Site
    </a>
</div>
{% endif %}
{% endblock %}