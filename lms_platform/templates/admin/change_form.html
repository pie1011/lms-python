{% extends "admin/base.html" %}
{% load admin_urls static admin_modify %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">
        {% if add %}
            Add {{ opts.verbose_name }}
        {% else %}
            Change {{ opts.verbose_name }}
        {% endif %}
    </h1>
    <div class="breadcrumbs">
        <a href="{% url 'admin:index' %}" class="breadcrumb-link">Home</a>
        <span class="breadcrumb-separator">›</span>
        <a href="{% url 'admin:app_list' app_label=opts.app_label %}" class="breadcrumb-link">{{ opts.app_config.verbose_name }}</a>
        <span class="breadcrumb-separator">›</span>
        <a href="{% url 'admin:'|add:opts.app_label|add:'_'|add:opts.model_name|add:'_changelist' %}" class="breadcrumb-link">{{ opts.verbose_name_plural|capfirst }}</a>
        <span class="breadcrumb-separator">›</span>
        <span>{% if add %}Add{% else %}Change{% endif %}</span>
    </div>
</div>

{% if errors %}
    <div class="message error">
        <i class="fas fa-exclamation-triangle"></i>
        Please correct the errors below.
    </div>
{% endif %}

<form method="post" class="admin-form" {% if has_file_field %}enctype="multipart/form-data"{% endif %}>
    {% csrf_token %}
    
    <div class="form-container">
        <div class="form-sections">
            {% for fieldset in adminform %}
                <div class="form-section">
                    {% if fieldset.name %}
                        <h2 class="form-section-title">{{ fieldset.name }}</h2>
                    {% endif %}
                    
                    {% if fieldset.description %}
                        <div class="form-section-description">{{ fieldset.description }}</div>
                    {% endif %}
                    
                    <div class="form-fields">
                        {% for line in fieldset %}
                            <div class="form-row {% if line.errors %}form-row-error{% endif %}">
                                {% for field in line %}
                                    <div class="form-field {% if field.field.required %}required{% endif %}">
                                        <label for="{{ field.field.html_name }}" class="form-label">
                                            {{ field.label_tag|safe }}
                                            {% if field.field.required %}<span class="required-indicator">*</span>{% endif %}
                                        </label>
                                        
                                        <div class="form-input-wrapper">
                                            {{ field.field|safe }}
                                            {% if field.help_text %}
                                                <div class="form-help-text">{{ field.help_text|safe }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        {% if field.errors %}
                                            <div class="form-errors">
                                                {% for error in field.errors %}
                                                    <div class="form-error">{{ error|safe }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div class="form-actions">
            <div class="form-actions-left">
                {% if not add %}
                    {% if has_delete_permission %}
                        <a href="{% url 'admin:'|add:opts.app_label|add:'_'|add:opts.model_name|add:'_delete' original.pk %}" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                            Delete
                        </a>
                    {% endif %}
                {% endif %}
            </div>
            
            <div class="form-actions-right">
                <a href="{% url 'admin:'|add:opts.app_label|add:'_'|add:opts.model_name|add:'_changelist' %}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Cancel
                </a>
                
                {% if has_add_permission or has_change_permission %}
                    <button type="submit" name="_save" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save
                    </button>
                    
                    {% if add and has_add_permission %}
                        <button type="submit" name="_addanother" class="btn btn-outline">
                            <i class="fas fa-plus"></i>
                            Save and add another
                        </button>
                    {% endif %}
                    
                    {% if not add and has_change_permission %}
                        <button type="submit" name="_continue" class="btn btn-outline">
                            <i class="fas fa-edit"></i>
                            Save and continue editing
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</form>

<!-- Show password change link for non-demo users -->
{% if not add and original and opts.model_name == 'user' and has_change_password_permission %}
    <div class="form-container" style="margin-top: 2rem;">
        <div class="form-section">
            <h2 class="form-section-title">Password</h2>
            <p style="margin-bottom: 1rem;">
                Raw passwords are not stored, so there is no way to see this user's password, 
                but you can change the password using 
                <a href="{% url 'admin:auth_user_password_change' original.pk %}" class="table-link">this form</a>.
            </p>
        </div>
    </div>
{% endif %}
{% endblock %}